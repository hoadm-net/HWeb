@model List<HWeb.Models.Product>
@{
    ViewData["Title"] = ViewData["CategoryName"]?.ToString() ?? "Danh mục sản phẩm";
    var categoryName = ViewData["CategoryName"]?.ToString() ?? "Danh mục";
    var categoryDescription = ViewData["CategoryDescription"]?.ToString() ?? "";
    var categoryIcon = ViewData["CategoryIcon"]?.ToString() ?? "fas fa-tag";
}

<div class="container">
    <!-- Page Header with Category Info -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a asp-controller="Products" asp-action="Index">Sản phẩm</a></li>
                    <li class="breadcrumb-item active" aria-current="page">@categoryName</li>
                </ol>
            </nav>
            
            <div class="category-header bg-light rounded p-4 mb-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="h2 fw-bold mb-2">
                            @categoryName
                        </h1>
                        <p class="text-muted mb-0">@categoryDescription</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="category-stats">
                            <span class="badge bg-primary fs-6">@Model.Count sản phẩm</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter and Sort Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="mt-2">
                <span class="text-muted">
                    Hiển thị @((ViewData["CurrentPage"] != null ? (int)ViewData["CurrentPage"] - 1 : 0) * 8 + 1) - 
                    @(Math.Min((ViewData["CurrentPage"] != null ? (int)ViewData["CurrentPage"] : 1) * 8, ViewData["TotalProducts"] != null ? (int)ViewData["TotalProducts"] : 0)) 
                    trong tổng số @(ViewData["TotalProducts"] ?? 0) sản phẩm
                </span>
            </div>
        </div>
        <div class="col-md-6">
            <div class="d-flex justify-content-end">
                <select class="form-select form-select-sm" style="width: auto;" onchange="alert('Chức năng đang phát triển')">
                    <option selected>Sắp xếp theo...</option>
                    <option value="name-asc">Tên A-Z</option>
                    <option value="name-desc">Tên Z-A</option>
                    <option value="price-asc">Giá thấp đến cao</option>
                    <option value="price-desc">Giá cao đến thấp</option>
                    <option value="newest">Mới nhất</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Products Grid -->
    @if (Model != null && Model.Any())
    {
        <div class="row g-4">
            @foreach (var product in Model)
            {
                <div class="col-lg-3 col-md-6">
                    <div class="card h-100 shadow-sm product-card">
                        <div class="product-image-container">
                            @if (!string.IsNullOrEmpty(product.ImageUrl))
                            {
                                <img src="@product.ImageUrl" 
                                     alt="@product.Name" 
                                     class="card-img-top product-image">
                            }
                            else
                            {
                                <div class="placeholder-image d-flex align-items-center justify-content-center">
                                    <i class="fas fa-image text-muted" style="font-size: 3rem;"></i>
                                </div>
                            }
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">
                                <a asp-controller="Products" asp-action="Details" asp-route-id="@product.Id" 
                                   class="text-decoration-none text-dark">
                                    @product.Name
                                </a>
                            </h5>
                            @if (product.Category != null)
                            {
                                <small class="text-muted mb-2">
                                    @{
                                        string productCategoryIcon = "fas fa-tag"; // default icon
                                        string productCategoryName = product.Category.Name.ToLower();
                                        
                                        if (productCategoryName.Contains("áo") || productCategoryName.Contains("sơ mi"))
                                        {
                                            productCategoryIcon = "fas fa-tshirt";
                                        }
                                        else if (productCategoryName.Contains("quần") || productCategoryName.Contains("tây"))
                                        {
                                            productCategoryIcon = "fas fa-user-tie";
                                        }
                                        else if (productCategoryName.Contains("váy") || productCategoryName.Contains("chân"))
                                        {
                                            productCategoryIcon = "fas fa-female";
                                        }
                                        else if (productCategoryName.Contains("giày") || productCategoryName.Contains("dép"))
                                        {
                                            productCategoryIcon = "fas fa-shoe-prints";
                                        }
                                        else if (productCategoryName.Contains("túi") || productCategoryName.Contains("balo"))
                                        {
                                            productCategoryIcon = "fas fa-shopping-bag";
                                        }
                                        else if (productCategoryName.Contains("phụ kiện") || productCategoryName.Contains("đồng hồ"))
                                        {
                                            productCategoryIcon = "fas fa-gem";
                                        }
                                    }
                                    <i class="@productCategoryIcon me-1"></i>@product.Category.Name
                                </small>
                            }
                            <div class="card-text flex-grow-1">@Html.Raw(product.ShortDescription)</div>
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="h5 text-primary mb-0">@product.Price.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</span>
                                    <a asp-controller="Products" asp-action="Details" asp-route-id="@product.Id" 
                                       class="btn btn-primary btn-sm">
                                        Thêm vào giỏ
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-12 text-center py-5">
                <div class="mb-4">
                    <i class="@categoryIcon text-muted" style="font-size: 4rem;"></i>
                </div>
                <h3 class="fw-bold">Chưa có sản phẩm @categoryName.ToLower()</h3>
                <p class="text-muted">Hiện tại chưa có sản phẩm nào trong danh mục này</p>
                <a asp-controller="Products" asp-action="Index" class="btn btn-outline-primary">
                    Xem tất cả sản phẩm
                </a>
                @if (User.IsInRole("Admin"))
                {
                    <a asp-area="Admin" asp-controller="Products" asp-action="Create" class="btn btn-primary ms-2">
                        Thêm sản phẩm mới
                    </a>
                }
            </div>
        </div>
    }
    
    @{
        var currentPage = ViewData["CurrentPage"] != null ? (int)ViewData["CurrentPage"] : 1;
        var totalPages = ViewData["TotalPages"] != null ? (int)ViewData["TotalPages"] : 1;
        var categoryAction = ViewData["CategoryAction"]?.ToString() ?? "Index";
    }
    
    <!-- Real Pagination for Category Pages - Only show if more than 1 page -->
    @if (Model != null && Model.Any() && totalPages > 1)
    {
        <div class="row mt-5">
            <div class="col-12">
                <nav aria-label="Product pagination">
                    <ul class="pagination justify-content-center">
                        <!-- Previous button -->
                        <li class="page-item @(currentPage <= 1 ? "disabled" : "")">
                            <a class="page-link" asp-controller="Products" asp-action="@categoryAction" asp-route-page="@(currentPage - 1)" 
                               tabindex="@(currentPage <= 1 ? "-1" : "")" aria-disabled="@(currentPage <= 1 ? "true" : "false")">
                                Trước
                            </a>
                        </li>

                        <!-- Page numbers -->
                        @{
                            var startPage = Math.Max(1, currentPage - 2);
                            var endPage = Math.Min(totalPages, currentPage + 2);
                        }

                        @if (startPage > 1)
                        {
                            <li class="page-item">
                                <a class="page-link" asp-controller="Products" asp-action="@categoryAction" asp-route-page="1">1</a>
                            </li>
                            @if (startPage > 2)
                            {
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            }
                        }

                        @for (int i = startPage; i <= endPage; i++)
                        {
                            <li class="page-item @(i == currentPage ? "active" : "")">
                                <a class="page-link" asp-controller="Products" asp-action="@categoryAction" asp-route-page="@i">@i</a>
                            </li>
                        }

                        @if (endPage < totalPages)
                        {
                            @if (endPage < totalPages - 1)
                            {
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            }
                            <li class="page-item">
                                <a class="page-link" asp-controller="Products" asp-action="@categoryAction" asp-route-page="@totalPages">@totalPages</a>
                            </li>
                        }

                        <!-- Next button -->
                        <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                            <a class="page-link" asp-controller="Products" asp-action="@categoryAction" asp-route-page="@(currentPage + 1)"
                               tabindex="@(currentPage >= totalPages ? "-1" : "")" aria-disabled="@(currentPage >= totalPages ? "true" : "false")">
                                Sau
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    }
</div>

<style>
    .category-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
    }
    
    .category-stats .badge {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
    }
    
    .product-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15) !important;
    }

    .product-image-container {
        position: relative;
        overflow: hidden;
        border-radius: 0.375rem 0.375rem 0 0;
    }

    .product-image {
        transition: transform 0.3s ease;
        object-fit: contain;
        width: 100%;
        height: 450px;
        object-position: center;
    }

    .product-card:hover .product-image {
        transform: scale(1.05);
    }

    .placeholder-image {
        height: 450px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        border-radius: 0.375rem 0.375rem 0 0;
    }
    
    .btn-outline-primary.active {
        background-color: var(--bs-primary);
        color: white;
        border-color: var(--bs-primary);
    }
</style>
